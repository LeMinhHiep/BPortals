@using MVCModel.Models;
@using MVCClient.Configuration;

@{Layout = "~/Views/Shared/_LayoutPopupWindow.cshtml";}


@(Html.Kendo().Grid<PendingSalesInvoice>()
    .Name("gridPendingSalesInvoices")
    .Columns(columns =>
    {
        columns.Bound(c => c.CommodityCode).Title("Mã xe, phụ tùng, dv").Width(15);
        columns.Bound(c => c.CommodityName).Title("Tên xe, phụ tùng, dv").Width(22);
        columns.Bound(c => c.ChassisCode).Title("Số khung").Width(15);
        columns.Bound(c => c.EngineCode).Title("Số máy").Width(12);
        columns.Bound(c => c.ColorCode).Title("Mã màu").Width(7);
        columns.Bound(c => c.Quantity).Title("SL").Format("{0:n0}").Width(5).HtmlAttributes(new { @class = "grid-number-column" });
        columns.Bound(c => c.GrossPrice).Title("Đơn giá").Format("{0:n0}").Width(10).HtmlAttributes(new { @class = "grid-number-column" });
        columns.Bound(c => c.GrossAmount).Title("Thành tiền").Format("{0:n0}").Width(10).HtmlAttributes(new { @class = "grid-number-column" });

        columns.Template(t => { }).Title("&nbsp;").ClientTemplate("<input class='IsSelected' #= IsSelected ? checked='checked':'' #  type='checkbox' />").Width(3);
    })
    .ToolBar(toolbar =>
    {
        toolbar.Template(@<text>
            <div class="toolbar" style="float: right;">
                <label class="category-label" for="category">Nhập xe, phụ tùng, số khung, số máy:</label>
                <input id="filterText" class="k-textbox" style="text-align: center;" onkeyup="onFilterTextKeyUp()" />
                @Html.Kendo().DateTimePicker().Name("FromDate").Value(DateTime.Today).Events(e => e.Change("reReadPendingSalesInvoices")).HtmlAttributes(new { @class = "input-class" })
                @Html.Kendo().DateTimePicker().Name("ToDate").Value(DateTime.Today.AddHours(23).AddMinutes(59).AddSeconds(59)).Events(e => e.Change("reReadPendingSalesInvoices")).HtmlAttributes(new { @class = "input-class" })

                @(Html.Kendo().DropDownList()
                    .Name("CommodityTypeID")
                    .DataTextField("Text")
                    .DataValueField("Value")
                    //.HtmlAttributes(new { @style = "width: 160px; text-align: center; ", @readonly = "readonly" })
                    .BindTo(new List<SelectListItem>()
                      {
                              
                              new SelectListItem { Text = "Xe", Value = "1"},
                            new SelectListItem { Text = "pt", Value = "2"},
                            new SelectListItem { Text = "vt", Value = "3"},
                            new SelectListItem { Text = "DV", Value = "6"},
                            new SelectListItem() {Text = "TT", Value = "999"}
                      })
                              .Events(e => e.Change("reReadPendingSalesInvoices"))
                )

            </div>
        </text>);
    })
    .Scrollable(s => s.Height(SettingsManager.PopupContentHeight))
    .DataSource(ds => ds.Ajax()
    .Read(read => read.Action("GetPendingSalesInvoices", "AccountInvoiceApi").Data(@<text>
            function(e) {
                return {
                    locationID: window.parent.requireConfig.pageOptions.LocationID,
                    accountInvoiceID: window.parent.$("#AccountInvoiceID").val(),
                    commodityTypeID: $("#CommodityTypeID").val(),
                    fromDate: $("#FromDate").val(),
                    toDate: $("#ToDate").val()
            };}

    </text>))
    .ServerOperation(false)) //If this is TRUE: Apply filter to datasource will call Ajax to get new datasource result. If this is FALSE: filter will run on client
    .Selectable()
)


<div class="background-bar" style="height: 45px;">
    <div class="popup-button-bar">
        <input id="okButton" type="button" value="OK" class="k-button" onclick="okButton_Click()" />
        <input id="cancelButton" type="button" value="Cancel" class="k-button" onclick="cancelButton_Click()" />
    </div>
</div>

<script src="@Url.Content("~/Scripts/Helpers/SalesTasks/accountInvoiceAddPendingSalesInvoice.js")"></script>

<script type="text/javascript">
    function okButton_Click() {
        handleOKEvent(window.parent.$("#kendoGridDetails").data("kendoGrid").dataSource, $("#gridPendingSalesInvoices").data("kendoGrid").dataSource);
    }

    $('#gridPendingSalesInvoices').on('click', '.IsSelected', function () {
        var checked = $(this).is(':checked');
        var grid = $('#gridPendingSalesInvoices').data().kendoGrid;
        var dataItem = grid.dataItem($(this).closest('tr'));
        dataItem.set('IsSelected', checked);
    })
</script>



<script>
    function reReadPendingSalesInvoices() { $("#gridPendingSalesInvoices").data("kendoGrid").dataSource.read() }

    function onFilterTextKeyUp() {
        var filterText = $("#filterText").val(), gridDetails = $("#gridPendingSalesInvoices").data("kendoGrid");

        if (filterText && filterText.length >= "@SettingsManager.AutoCompleteMinLenght") {

            gridDetails.dataSource.filter({
                logic: "or",
                filters: [
                  { field: "CommodityCode", operator: "contains", value: filterText },
                  { field: "CommodityName", operator: "contains", value: filterText },
                  { field: "ChassisCode", operator: "contains", value: filterText },
                  { field: "EngineCode", operator: "contains", value: filterText }
                  //{ field: "IsSelected", operator: "eq", value: true }
                ]
            });


        } else {
            gridDetails.dataSource.filter({});
        }
    }
</script>

